// eval("""@JSXBIN@ES@2.0@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""");
#target photoshop 
var myPaths = app.activeDocument.pathItems;
var myLayer = app.activeDocument.artLayers;
var checkPathActive = true;

//take snapshot
var snapshot=null;
for(var i=0; i< activeDocument.historyStates.length;i++){
    if(activeDocument.historyStates[i].name=="AdvPathCache"){
        snapshot= activeDocument.historyStates[i]; break;
    }
}
if(snapshot ==null){
    createSnapshot ("AdvPathCache");
}
else{
    deleteSnapShot (snapshot.name);
    createSnapshot ("AdvPathCache");
}
//-------------
try{
    myPaths.getByName("Parent");
}
catch(err){
    var myActPathName = getPathNameActive();
    if(myActPathName=="Work Path" || myActPathName==undefined){
        alert ("Select the overall path layer" , "Warning");
        checkPathActive = false;
        throw err;
    }
    var pathSysExist = false;
    for (var i = 0; i < myPaths.length ; i++){
        if(myPaths[i].name.search("Pixelz_AutoPath") != -1){
            var pathSys = myPaths[i];
            myPaths.getByName( myActPathName).remove();
            pathSys.duplicate(myActPathName);
            var mycopyPath = myPaths.getByName(myActPathName);
            movePath(mycopyPath,0);
            pathSys.name= "Parent";
            pathSysExist= true;
            break;
        }
    }
    if(!pathSysExist){ 
        myPaths.getByName(myActPathName).duplicate("Parent");
    }
}
finally{
    if (checkPathActive){
        boxAdvPath();
    }
}
function boxAdvPath(){
    var boxAdv = new Window("dialog","Academy Adv Path", undefined, {closeButton:true});
    var grList = boxAdv.add("group{orientation:'row'}");
    grList.add("statictext{text:'Path Name:'}");
    var listPathName = grList.add("dropdownlist{size:[100,25]},active=true");
        listPathName.graphics.font = ScriptUI.newFont ("Myriad Pro", "Regular", 14) 
        listPathName.active= true;
        
     var grList2 = boxAdv.add("group{orientation:'row'}");
     var listgrList = grList2.add("statictext{text:'Path Add:   '}");
     listgrList.hide();
     var listAdd = grList2.add("dropdownlist{size:[100,25]}");
     listAdd.graphics.font = ScriptUI.newFont ("Myriad Pro", "Regular", 14);
     listAdd.enabled = false;
     listAdd.hide();
    var btnRun = boxAdv.add("button{size: [100,20], text: 'Run', properties:{name:'ok'}}");
    var checkBoxMode = boxAdv.add("checkbox{text:'Update mode', alignment:'left', value:false}");
    for(var i=0; i< myPaths.length; i++){
        if(myPaths[i].subPathItems.length==0){
            listPathName.add("item{text:'"+myPaths[i].name+"', properties:{indexPath:"+i+"}}" );
        }
        if(myPaths[i].name == "Work Path"){ hasWorkpath = true;}
    }
    listPathName.selection = listPathName.items[0];
    if(!hasWorkpath){ alert("No PSWorkPath", "Warning"); return;}
    //handle button 'Run'
    btnRun.addEventListener ("click", function(){
        processPath(listPathName.selection.text, listPathName.selection.properties.indexPath,listAdd.selection, checkBoxMode.value);
        var snapFin = activeDocument.historyStates.getByName("fin-Combine");
        activeDocument.activeHistoryState = snapFin;
        activeDocument.quickMaskMode = true;
        deleteSnapShot (snapFin.name);
        boxAdv.close();
    });
    //handle list
    listPathName.addEventListener ("keydown", triggerBtnRun);
    listAdd.addEventListener ("keydown", triggerBtnRun);
    function triggerBtnRun (e){
        if(e.keyName=="Space"){
            btnRun.dispatchEvent(new Event("click"))
        }
    }
       //handle checkbox Mode
    checkBoxMode.onClick = function(){
        listPathName.removeAll();
        listAdd.removeAll();
        listgrList.show();
        listAdd.show();
        listAdd.enabled = this.value;
        for(var i=0; i< myPaths.length; i++){
            if(this.value){
                if(myPaths[i].subPathItems.length>0){
                    listPathName.add("item{text:'"+myPaths[i].name+"', properties:{indexPath:"+i+"}}" );
                    listAdd.add("item{text:'"+myPaths[i].name+"', properties:{indexPath:"+i+"}}" );
                }
            }
            else if(myPaths[i].subPathItems.length==0){
                listPathName.add("item{text:'"+myPaths[i].name+"', properties:{indexPath:"+i+"}}" );
            }
        }
        listPathName.selection = listPathName.items[0];
    }
    boxAdv.show();
}
function processPath(eachPath, index, objSubPath, updateMode){
    app.activeDocument.quickMaskMode = false;
    try{activeDocument.selection.deselect() }catch(err){};
    var parentPath = "Parent", indexParent = 1;
    var workPath = myPaths.getByName("Work Path");
    if(objSubPath!=null && objSubPath.text != eachPath){
        parentPath = eachPath;
        indexParent = index;
        eachPath = objSubPath.text;
        index = objSubPath.properties.indexPath;
    }
    myPaths.getByName(parentPath).select();
    advancePath.createShapeLayer("Shape 1");
    workPath.select();
    advancePath.mergePath().createShapeLayer("Shape 2");
    myLayer.getByName("Shape 1").duplicate().name = "Shape 1 Parent";
    myLayer.getByName("Shape 2").duplicate().name = "Shape 2 Parent";
    //check mode update//
    if(updateMode){
        advancePath.addLayerCon("Shape 1").subtractChild().mergePath().createPathfromShape("PathUpdate");
        var pathUpdate = myPaths.getByName("PathUpdate");
        var shapeUpdate = advancePath.createShapeLayer("Shape Update");
        myPaths.getByName(eachPath).select();
        var shapeEach = advancePath.createShapeLayer(eachPath);
        myPaths.getByName(eachPath).remove();
        advancePath.addLayerCon(shapeUpdate.name).addPaths().mergePath().createPathfromShape(eachPath).deselectPath();
        var eachPath = myPaths.getByName(eachPath);
        myLayer.getByName(eachPath.name).remove();
        pathUpdate.remove();
    }
    else{
        myPaths.getByName(eachPath).remove();
        advancePath.addLayerCon("Shape 1").subtractChild().mergePath().createPathfromShape(eachPath).deselectPath();
        var eachPath = myPaths.getByName(eachPath);
    }  
    app.activeDocument.activeLayer = myLayer.getByName("Shape 2 Parent");
    myPaths.getByName(parentPath).remove();
    advancePath.addLayerCon("Shape 1 Parent").subParent().mergePath().createPathfromShape(parentPath).deselectPath();
    myLayer.getByName("Shape 2").remove();
    myLayer.getByName("Shape 2 Parent").remove();
    movePath(myPaths.getByName(parentPath), indexParent); 
    movePath(eachPath, index); 
    eachPath.deselect();
    myPaths.getByName("Work Path").remove();
    myPaths.getByName("Parent").makeSelection();
    //app.activeDocument.quickMaskMode = true;
    createSnapshot ("fin-Combine");
};

function getPathNameActive(){
    var ref = new ActionReference();
    ref.putEnumerated( charIDToTypeID("Path"), charIDToTypeID("Ordn"), charIDToTypeID("Trgt") );
    try{
        var desGet = executeActionGet(ref);
        var name = desGet.getString(stringIDToTypeID("pathName"));
    }catch(err){ 
        var hasFound = false;
        for(var i = 0; i<myPaths.length; i++){
            if( myPaths[i].name=="Path 1" ) {
                myPaths[i].select();
                var name = myPaths[i].name;
                hasFound = true;
                break
            }
            else if (i ==myPaths.length-1) {
                alert("No Path actived");}
            }
        }
    return name;
}
function updatePath () {
    
}
function movePath(pathItem, index){
    pathItem.select();
    var desc59 = new ActionDescriptor();
    var ref27 = new ActionReference();
    ref27.putEnumerated( charIDToTypeID( "Path" ), charIDToTypeID( "Ordn" ), charIDToTypeID( "Trgt" ) );
    desc59.putReference( charIDToTypeID("null"), ref27 );
    var ref28 = new ActionReference();
    ref28.putIndex( charIDToTypeID( "indx" ), index );
    desc59.putReference( charIDToTypeID( "T   " ), ref28 );
    executeAction( charIDToTypeID( "move" ), desc59, DialogModes.NO );
}
function createSnapshot(name){
    var desc8 = new ActionDescriptor();
        var ref1 = new ActionReference();
        ref1.putClass( charIDToTypeID( "SnpS" ) );
    desc8.putReference( charIDToTypeID( "null" ), ref1 );
        var ref2 = new ActionReference();
        ref2.putProperty( charIDToTypeID( "HstS" ), charIDToTypeID( "CrnH" ));
    desc8.putReference( charIDToTypeID( "From" ), ref2 );
    desc8.putString( charIDToTypeID( "Nm  " ), name );
    desc8.putEnumerated( charIDToTypeID( "Usng" ), charIDToTypeID( "HstS" ), charIDToTypeID( "FllD" ));
    executeAction( charIDToTypeID( "Mk  " ), desc8, DialogModes.NO );
};
function deleteSnapShot(name){
    var desc381 = new ActionDescriptor();
        var ref21 = new ActionReference();
        ref21.putName( charIDToTypeID( "SnpS" ), name );
    desc381.putReference( charIDToTypeID( "null" ), ref21 );
    executeAction( charIDToTypeID( "Dlt " ), desc381, DialogModes.NO );
};